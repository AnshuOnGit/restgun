<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Typescript playground on ace editor</title>
<meta name="description" content="Typescript playground on ace editor" />
<meta>
<link type="text/css" rel="stylesheet"
	href="stylesheets/bootstrap.min.css" />
<link
	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/ui-darkness/jquery-ui.min.css"
	rel="stylesheet">

<link type="text/css" rel="stylesheet" href="stylesheets/style.css" />
<link type="text/css" rel="stylesheet"
	href="assets/css/jquery.tag-editor.css" />



<link rel="stylesheet" type="text/css"
	href="http://static.jstree.com/3.0.0-beta3/assets/dist/themes/default/style.min.css">



<script src="http://lui.in.here.com/lui-all.min.js"></script>
<style type="text/css">
#respArea {
	width: 100%;
	height: 300px;
}

.jstree-themeicon-custom {
	background-size: 20px !important;
}
.ui-dialog{
	width:500px!important;
}
</style>
</head>
<body>
	<lui-desktopnavigation> <lui-tabbar line>
	<lui-tab selected>CMS Scripting</lui-tab> <a href="/guides"><lui-tab
			semimanual>About</lui-tab></a> </lui-tabbar> 
			
			
			</lui-desktopnavigation>
	<div class="fluid-container" >
		<div>
			<div style="height:40px;padding: 5px;box-shadow: rgba(0,0,0,0.2) 0 2px 6px 0">
				
				<div>
					<ul style="float:left">
						<li>shortcut key [Ctrl-Space] : AutoComplete</li>
					</ul>
					<select style="float:right" id="env"><option value="uat">UAT</option><option value="dev">DEV</option></select>
				</div>
			</div>
			<br>
		</div>

		<div class="editor-area">


			<div class="warp-container0">

				<div id="jstree"></div>

			</div>

			<div class="warp-container1">
				<div class="langauge-title" style="float: left;">
					<!-- <div style="float: left;">
						<lui-button disabled>TypeScript</lui-button>

					</div> -->
					<div style="float: left; padding-top: 5px; padding-left: 20px">
						<!-- <select id="select-sample">
				<option selected="selected" value="ms.ts">MS</option>
              </select> -->
						<select id="select-extent"
							style="width: 100px; height: 32px; line-height: 30px; margin: 0px">
							<option selected="selected" value="Link">Link</option>
						</select> <input id="extentValue" class="form-control" value="117711870"
							style="padding: 5px; border: 1px solid #aaa; width: 200px; border-radius: 4px" />

						<!-- 						<textarea style="height: 32px;width:300px" rows="" cols="" id="params">{"name":"Dhaneesh"}</textarea>
 -->
					</div>



					<div style="clear: both"></div>
				</div>
				<div class="editor-container">

					<div id="editor"></div>
				</div>
			</div>

			<div class="warp-container2">
				<div class="langauge-title" style="float: right; width: 100%">
					<div>
						
						<lui-button style="float:right;margin-right:10px" id="javascript-run">Run</lui-button>
						<lui-button style="float:right;margin-right:10px" id="show">Save</lui-button>
					</div>
					<!-- <table class="row" style="width: 98%; float: right">
						<tr>
							<td class="col" style="width: 300px"></td>
							<td class="col" style="width: 100px">
								  
							</td>
						</tr>
					</table> -->



				</div>
				<div style="clear: both"></div>


				<div class="editor-container" style="float: right">
					<div id="output"></div>
				</div>
			</div>
		</div>
		<div id="dialog" title="System Busy"
			style="width: 500px !important">
			<p>Please wait......</p>

		</div>
		
		<div id="serviceDialog" title="CMS Service Body"
			style="width: 700px !important">
			<h2 class="method">POST</h2>
			<p class="url">
			
			
			</p>
			<pre class="body">
			
			
			</pre>
			
			<p>
				<a class="sendEmail" href="mailto:CMS_Mumbai@here.com?subject=Sample CMS Service&body=">Send to CMS_Mumbai</a>
			</p>

		</div>

	</div>

	<footer>
		<div class="footer" style="padding: 5px;">
				<p>Email your queries to CMS_Mumbai <a
					href="mailto:CMS_Mumbai@here.com">CMS_Mumbai@here.com</a></p>
		</div>
	</footer>

</body>

<script type="text/javascript">
	var exports = {};
</script>

<script type="text/javascript"
	src="./javascripts/lib/jquery-1.8.2.min.js"></script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"></script>

<script type="text/javascript" src="./javascripts/lib/ace/ace.js"></script>

<script type="text/javascript"
	src="./javascripts/lib/typescript/typescriptServices.js"></script>

<script type="text/javascript" src="./javascripts/lightHarness.js"></script>
<script type="text/javascript" src="./javascripts/autoComplete.js"></script>
<script type="text/javascript"
	src="./javascripts/documentPositionUtil.js"></script>
<script type="text/javascript" src="./javascripts/editorPosition.js"></script>
<script type="text/javascript" src="./javascripts/compilationService.js"></script>
<script type="text/javascript" src="./javascripts/fileService.js"></script>
<script type="text/javascript" src="./javascripts/autoCompleteView.js"></script>

<script type="text/javascript" src="assets/js/jquery.tag-editor.min.js"></script>
<script type="text/javascript" src="./javascripts/main.js"></script>

<script
	src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

<script type="text/template" id="script2">
var linkItr = mapContext.linkIterator()
var length = 0
while(linkItr.hasNext()){
 var link = linkItr.next()
 length+=link.length()
}
var fLink:FlatLink=mapContext.linkIterator().next().makeFlat()
fLink.setUrban(false)
//Update the changed object
cms.execute(mapContext,fLink,"UPDATE")
length
</script>

<script type="text/template" id="script3">
var linkItr = mapContext.linkIterator()
var length = 0
while(linkItr.hasNext()){
 var link = linkItr.next()
 length+=link.length()
}
var fLink:FlatLink=mapContext.linkIterator().next().makeFlat()
fLink.setAligned(true)
//Update the changed object
cms.execute(mapContext,fLink,"UPDATE")
length
</script>

<script type="text/javascript">
$(document).ready(function() {

	$('#parameters').tagEditor();

	$("#javascript-run").click(function(e) {
		javascriptRun();
	});
	
	$("#show").click(function(e) {
		//$("#serviceDialog .method").html("POST");
		var rb=JSON.stringify(requestBody(),null,2);
		 $("#serviceDialog .sendEmail").attr("href","mailto:CMS_Mumbai@here.com?subject=Sample CMS Service&body="+rb);
		
		$("#serviceDialog .url").html("http://cms-"+$("#env").val()+".cme.in.here.com/script/execute?userName=1cmstst");
		$("#serviceDialog .body").html(rb);
		$("#serviceDialog").dialog('open');
	});

});

var Base64 = {
	characters : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

		encode : function(string) {
			var characters = Base64.characters;
			var result = '';

			var i = 0;
			do {
				var a = string.charCodeAt(i++);
				var b = string.charCodeAt(i++);
				var c = string.charCodeAt(i++);

				a = a ? a : 0;
				b = b ? b : 0;
				c = c ? c : 0;

				var b1 = (a >> 2) & 0x3F;
				var b2 = ((a & 0x3) << 4) | ((b >> 4) & 0xF);
				var b3 = ((b & 0xF) << 2) | ((c >> 6) & 0x3);
				var b4 = c & 0x3F;

				if (!b) {
					b3 = b4 = 64;
				} else if (!c) {
					b4 = 64;
				}

				result += Base64.characters.charAt(b1)
						+ Base64.characters.charAt(b2)
						+ Base64.characters.charAt(b3)
						+ Base64.characters.charAt(b4);

			} while (i < string.length);

			return result;
		},

		decode : function(string) {
			var characters = Base64.characters;
			var result = '';

			var i = 0;
			do {
				var b1 = Base64.characters.indexOf(string.charAt(i++));
				var b2 = Base64.characters.indexOf(string.charAt(i++));
				var b3 = Base64.characters.indexOf(string.charAt(i++));
				var b4 = Base64.characters.indexOf(string.charAt(i++));

				var a = ((b1 & 0x3F) << 2) | ((b2 >> 4) & 0x3);
				var b = ((b2 & 0xF) << 4) | ((b3 >> 2) & 0xF);
				var c = ((b3 & 0x3) << 6) | (b4 & 0x3F);

				result += String.fromCharCode(a)
						+ (b ? String.fromCharCode(b) : '')
						+ (c ? String.fromCharCode(c) : '');

			} while (i < string.length);

			return result;
		}
	};
	
	function requestBody(){
		var source = currentEditorValue;
		var requestObj = {
				"id" : "",
				"script" : Base64.encode(source),
				"contexts" : [ {
					"type" : $("#select-extent").val(),
					"value" : $("#extentValue").val()
				}
				]

			};
		
		return requestObj;
			
	}

	function javascriptRun() {
		
		//		{
		//			  "id" : "",
		//			  "script" : "dmFyIGxpbms9bWFwQ29udGV4dC5maW5kTGluayg4NDYzODI5NzI2KS5tYWtlRmxhdCgpO2xpbmsuaWQoKQ==",
		//			  "contexts" : [ {
		//			    "type" : "Link",
		//			    "value" : "8463829726"
		//			  } ]
		//			}

		var requestObj = requestBody();
		
		outputEditor.getSession().doc.setValue("");
		$("#dialog").dialog("open");

		$("#respArea").html("");
		var data = JSON.stringify(requestObj);

		$
				.ajax({
					type : "POST",
					url : "http://cms-uat.cme.in.here.com/script/execute?userName=1cmstst",
					data : data,
					success : function(data, status) {
						successCallBack(data);
					},
					error : function(xhr,response) {
						errorCallBack(response+":"+xhr.responseText);
					},
					async : true
				});
	}

	function successCallBack(data) {
		outputEditor.getSession().doc.setValue(JSON.stringify(data, null, 2));
		//alert("Success Execute :" + JSON.stringify(data));
		$("#dialog").dialog("close");
	}

	function errorCallBack(response) {
		$("#dialog").dialog("close");
		outputEditor.getSession().doc.setValue(response);
	}

	$(function() {
		$("#dialog").dialog({
			autoOpen : false
		});
		
		$("#serviceDialog").dialog({
			autoOpen : false
		});
		
		$("#params").change(function(){
			
			loadParams();
		});
		
	});
	
	
	$(function () {
        var jsondata = [
                        {
                       	"id": "mapContext1", "text": "Sample Script 1",
                    	"icon": "assets/img/eye.png",
   	                    "state": {
   	                        "opened": true,
   	                        "disabled": false,
   	                        "selected": false
   	                    },
   	                    "children": false,
   	                    "liAttributes": null,
   	                    "aAttributes": null   
                       },
                       {
                          	"id": "mapContext2", "text": "Sample Script 2",
                       	"icon": "assets/img/eye.png",
      	                    "state": {
      	                        "opened": true,
      	                        "disabled": false,
      	                        "selected": false
      	                    },
      	                    "children": false,
      	                    "liAttributes": null,
      	                    "aAttributes": null   
                          },
                          {
                            	"id": "mapContext3", "text": "Sample Script 3",
                         	"icon": "assets/img/eye.png",
        	                    "state": {
        	                        "opened": true,
        	                        "disabled": false,
        	                        "selected": false
        	                    },
        	                    "children": false,
        	                    "liAttributes": null,
        	                    "aAttributes": null   
                            }
                       
                       
                       ];

        createJSTree(jsondata);
    });

    function createJSTree(jsondata) {
        $('#jstree').jstree({
        	'core': {
	            'data': [{
	                "id": "1.0",
	                "text": "All",
	                "icon": "",
	                "state": {
	                    "opened": true,
	                    "disabled": false,
	                    "selected": false
	                },
	                "children":jsondata,
	                "liAttributes": null,
	                "aAttributes": null
	            }]
	        },
	        "search": {

	            "case_insensitive": true,
	            "show_only_matches" : true,
	            "fuzzy":false
	        },
	        "plugins": ["search"]
        });
        
        $('#jstree').on("select_node.jstree", function (e, data) {
        	
        	var scriptObj = scriptMap[data.node.id];
        	var context=scriptObj.contexts[0];
        	$("#select-extent").val(context.type);
        	$("#extentValue").val(context.value);
        	$("#dialog").dialog("open");
        	cExpect=function(){
        		$("#dialog").dialog("close");
        	};
        	editor.setValue(scriptObj.script);
            editor.moveCursorTo(0, 0);
            
            //editor.
        });

    }
    
    function loadParams(){
    	
    	//loadStaticContent("typescripts/lib.d.ts",'var params ='+$("#params").val(),true);
    }
    
    var preScript="/////////Start Params\n"+
"var params = {}\n"+
"//Donot delete this block. It is mandatory to have this with every script.\n"+
"//Params will automatically removed while saving the script.\n//Params can be provided as a runtime object while invoking the script.\n"+
"/////////End Params\n";
    var source1=preScript+"var linkItr = mapContext.linkIterator()\nvar length = 0\nwhile(linkItr.hasNext()){\n var link = linkItr.next()\n length+=link.length()\n}\nlength";

    
    var source2=preScript+$("#script2").html();
    var source3=preScript+$("#script3").html();
    
    var scripts=[
                 {"id":"mapContext1","name":"MapContext Sample Script 1","script":source1,"contexts":[{"type":"Link","value":"117711870"}]},
                 {"id":"mapContext2","name":"MapContext Sample Script 2","script":source2,"contexts":[{"type":"Link","value":"117711870"}]},
                 {"id":"mapContext3","name":"MapContext Sample Script 3","script":source3,"contexts":[{"type":"Link","value":"117711870"}]}
                 ]
    
    var cExpect=null;
	var scriptMap =   scripts.reduce(function(map, obj) {
	    map[obj.id] = obj;
	    return map;
	}, {});
	
	loadParams();
</script>

</html>
