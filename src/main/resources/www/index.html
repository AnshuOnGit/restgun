<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
<title>CMS REST</title>

<!-- CSS  -->

<link href="https://fonts.googleapis.com/icon?family=Material+Icons"
	rel="stylesheet">
<link href="assets/css/materialize.css" type="text/css" rel="stylesheet"
	media="screen,projection" />
<link href="assets/css/materialstyle.css" type="text/css"
	rel="stylesheet" media="screen,projection" />
<!--
<link rel="stylesheet" href="leaflet.css" /> -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css"
	rel="stylesheet" />

<link
	href="http://netdna.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"
	rel="stylesheet">

<!-- 
<link rel="stylesheet" type="text/css" href="/css/result-light.css"> -->






<link rel="stylesheet" type="text/css"
	href="http://static.jstree.com/3.0.0-beta3/assets/dist/themes/default/style.min.css">



<style>
.brand-logo {
	background-color: #fff;
	background-image: url('assets/images/download.svg');
	background-position: 16px 20px;
	background-repeat: no-repeat;
	color: #fff;
	display: block;
	float: left;
	text-indent: -9000em;
	width: 86px;
	z-index: 4;
}
</style>
<script src="assets/js/leaflet.js"></script>
<script src="assets/js/rotate.js"></script>
<style>
.text-labels {
	color: black;
	font-size: 1em;
	top: -4px;
	left: 2px;
}

div.box {
	height: calc(100% - ( 110px));
}

div.div1 {
	float: left;
	width: 100%;
	margin-top: 20px;
}

div.div2 {
	float: left;
	background: #666;
	width: 40%;
	height: 100%;
	overflow-y: auto;
}

div.clear {
	clear: both;
	height: 1px;
	overflow: hidden;
	font-size: 0pt;
	margin-top: -1px;
}

#map {
	width: 100%;
	height: 100%;
}

.box .row .col {
	padding: 0 0rem;
}

.select2 {
	width: 80% !important;
	text-align: center;
}

.select2-container--default.select2-container .select2-selection--multiple
	{
	border: none;
	border-bottom: 1px solid black;
	border-radius: 0px;
	padding: 20p;
	margin: 0px;
	padding: 0px;
}

.select2-selection--multiple {
	border: 0px solid black;
}

.select2-selection__choice {
	background-color: #fff !important;
	border: 1px solid #fff !important;
}

.select2-selection__choice__remove {
	color: #fff !important;
}

.select2-search input {
	height: 1.5rem !important;
}
/* header, main, footer {
      padding-left: 300px;
    }

    @media only screen and (max-width : 992px) {
      header, main, footer {
        padding-left: 0;
      }
    } */
.container {
	width: 95%;
}

#toast-container {
	right: 0px;
}

header, main, footer {
	padding-left: 300px;
}

@media only screen and (max-width : 992px) {
	header, main, footer {
		padding-left: 0;
	}
}

#queryTable td {
	max-width: 220px;
	word-wrap: break-word;
}

.jstree-themeicon-custom {
	background-size: 100% !important;
}

#modal1 {
	top: 0% !important;
}
</style>
</head>
<body>
	<nav>
		<div class="nav-wrapper" style="background: #0f1621">
			<a href="#!" class="brand-logo"><i class="material-icons">cloud</i>


			</a>

			<ul class="right hide-on-med-and-down">

				<li><a class="dropdown-button" href=""
					data-activates="dropdown2" style="width: 200px"> <span
						id="projectName">Select Project</span><i
						class="material-icons right">arrow_drop_down</i></a></li>
			</ul>
			<ul class="right hide-on-med-and-down">
				<li><a class="modal-trigger" href="#openProjectModal"><i
						id="addProject"
						style="width: 56px; height: 56px; line-height: 56px; margin: 5px; padding: 0px"
						class="btn-floating waves-effect waves-light green material-icons center">add</i>
				</a></li>

			</ul>
		</div>
	</nav>

	<ul id="dropdown2" class="dropdown-content">
		<li><a href="#">cms</a></li>
		<li class="divider"></li>
		<li><a href="#">pointbinding</a></li>
		<li class="divider"></li>
		<li><a href="#">onstreetparking</a></li>
	</ul>


	<ul id="slide-out" class="side-nav fixed">
		<li><div class="userView">
				<div class="background" style="background:#0f1621">
				</div>
				<a><span
					style="float: right; padding: 4px; margin: 0px; background: white; line-height: 24px; border-radius: 5px; cursor: pointer"
					onclick="logOff();">Logoff <i class="fa fa-sign-out"
						aria-hidden="true"></i></span></a> <a href="#!user"><img class="circle"
					src="assets/images/user.png"></a> <a href="#!name"><span
					class="white-text name" id="userDisplayName"></span></a> <a
					href="#!email"><span class="white-text email" id="userEmail"></span>
				</a>

			</div></li>
		<!-- <li><a href="#!"><i class="material-icons">cloud</i>First Link With Icon</a></li>
    <li><a href="#!">Second Link</a></li>
    <li><div class="divider"></div></li>
    <li><a class="subheader">Subheader</a></li>
    <li><a class="waves-effect" href="#!">Third Link With Waves</a></li> -->

		<li class="row">
			<div class="col s12">
				<ul class="tabs">
					<li class="tab col s6"><a class="active" href="#test1">Test
							Cases</a></li>
					<li class="tab col s6"><a href="#test2">Hosts</a></li>
				</ul>
			</div>
			<div id="test1" class="col s12">

				<div style="padding: 20px;">
					<i class="material-icons" style="position: absolute;">search</i> <input
						class="search-input form-control" style="padding-left: 40px;">
				</div>

				<div id="jstree"></div>
			</div>
			<div id="test2" class="col s12">


				<div>

					<div class="row card" style="margin-top: 5px;">

						<div class="col s1"
							style="padding: 0px; float: right; margin-right: 20px;">
							<i id="addHost"
								class="btn-floating waves-effect waves-light green material-icons center">add</i>
						</div>
						<div class="col s12">
							<div class="input-field">
								<input id="nameInput" style="font-size: 12px" type="text"
									class="validate" value=> <label for="nameInput">Name</label>
							</div>
						</div>
						<div class="col s12">
							<div class="input-field">
								<input id="hostInput" style="font-size: 12px" type="text"
									class="validate" value=> <label for="hostInput">Host
									Address</label>
							</div>
						</div>

					</div>

					<table id="hostTable">
						<thead>
							<tr>
								<th data-field="name">Name</th>
								<th data-field="name">Host</th>
							</tr>
						</thead>

						<tbody>

							<!-- <tr>
													<td>Jonathan</td>
													<td>Lollipop</td>
												</tr> -->
						</tbody>
					</table>


				</div>





			</div>

		</li>

		<li></li>
	</ul>
	<a href="#" data-activates="slide-out" class="button-collapse"><i
		class="material-icons">menu</i></a>




	<main>
	<div class="container">

		<div class="row">
			<div class="col s12">

				<div class="row">
					<div class="col s2">
						<!-- Dropdown Trigger -->
						<div class="row" style="padding-top: 20px">
							<a id="request" style="" class='dropdown-button btn' href='#'
								data-activates='dropdown1'>GET</a>

							<!-- Dropdown Structure -->
							<ul id='dropdown1' class='dropdown-content'>
								<li><a href="#!">GET</a></li>
								<li class="divider"></li>
								<li><a href="#!">POST</a></li>
								<li class="divider"></li>
								<li><a href="#!">PUT</a></li>
								<li class="divider"></li>
								<li><a href="#!">DELETE</a></li>
							</ul>
						</div>
					</div>
					<div class="col s9">
						<div class="input-field">
							<input id="url" style="font-size: 12px" type="text"
								class="validate"
								value="http://cms-dev.in.here.com/road?minx=15.26000&miny=47.43000&maxx=15.29000&maxy=47.49000">
							<label for="url">URL</label>
						</div>
					</div>

					<div class="col s1">
						<div class="row" style="padding-top: 20px">
							<a class="btn-floating btn-large waves-effect waves-light green"
								id="send"><i class="material-icons">send</i></a>

						</div>
					</div>
				</div>
				<ul class="content" data-collapsible="fixed">
					<li>

						<div class="collapsible-header grey active " style="padding: 0px">

							<div class="col grid-example s4 m4 4 teal lighten-1">
								<span class="flow-text">Request</span>
							</div>
							<div class="col grid-example s8 m8 8 lightblue-1"
								style="background: #0f1621; color: white">
								<span class="flow-text">Response</span> <a
									class="modal-trigger waves-effect waves-light btn right"
									href="#modal1" style="margin: 5px;"><i
									class="material-icons left">code</i>Show Test Case</a>
							</div>


						</div>
						<div class="content">
							<div class="col s4" style="padding: 0px">
								<div class="card" style="margin: 0px">
									<textarea id="requestBody"
										style="height: 500px; overflow-y: scroll; background: #0f1621; color: yellow;"></textarea>
								</div>
							</div>
							<div class="col s8" style="padding: 0px; height: 500px;">

								<div class="card" style="margin: 0px" id="respCard">
									<textarea id="responseBody"
										style="height: 413px; overflow-y: scroll; background: #0f1621; color: #fff;"></textarea>

									<div class="card-content" style="height: 87px; padding: 0px">
										<span class="card-title activator grey-text text-darken-4">
											<!-- <i class="material-icons right"></i> --> <i
											id="openAssert"
											class="btn-floating waves-effect waves-light green material-icons center right">more_vert</i>
										</span>
										<table>
											<tr>
												<td id="responseCode" style="padding: 0px"><span
													id="responseIcon"></span>Response Code:<span>---------</span></td>
												<td id="timeTaken">Time Taken:<span>------</span></td>
											</tr>
										</table>

									</div>
									<div class="card-reveal" style="width: 60%; right: 0px;">
										<span class="card-title grey-text text-darken-4">Asserts<i
											class="material-icons right">close</i>
										</span>
										<div class="row">
											<div class="col s11">
												<input id="queryInput"></input>
											</div>
											<div class="col s1" style="padding: 0px">
												<i id="addAssertion"
													class="btn-floating waves-effect waves-light green material-icons center">add</i>
											</div>
										</div>
										<p style="padding: 0px" id="queryOutput"></p>

										<table id="queryTable">
											<thead>
												<tr>

													<th data-field="name">Assertion</th>
													<th data-field="price">Result</th>
												</tr>
											</thead>

											<tbody>

												<!-- <tr>
													<td>Jonathan</td>
													<td>Lollipop</td>
												</tr> -->
											</tbody>
										</table>


									</div>
								</div>

							</div>

						</div>
					</li>
					<!-- <li>
				<div class="collapsible-header active">
					<i class="material-icons">place</i>Response
				</div>
				<div class="collapsible-body">
					<textarea id="responseBody"
						style="height: 400px; overflow-y: scroll;background: #123456;color: #fff;"></textarea>
				</div>
			</li>
 -->
				</ul>



			</div>

			<div class="col s4"></div>
		</div>
	</div>


	</main>

	<div id="openProjectModal" class="modal" style="max-width: 500px;">

		<div class="modal-content">

			<div class="row">
				<div class="testcase col s12" style="padding: 0px; height: 100%;">
					<div class="row" style="height: 100%; margin: auto">
						<div class="col grid-example s12 m12 12 teal">
							<!-- <h2>Configure New Project</h2> -->
							<span class="flow-text">Configure New Project</span>
						</div>


						<form class="col s12 white" style="height: 100%" id="inform">
							<div class="row">
								<div class="input-field col s12">
									<input id="nprojectName" type="text" class="validate"><label
										for="nprojectName">Project Name</label>
								</div>
								<div class="input-field col s12">
									<textarea id="npdescription"
										class="validate materialize-textarea"></textarea>
									<label for="npdescription">Project Description</label>
								</div>
							</div>

						</form>
						<div class="row">
							<div class="input-field col s12">
								<a id="createProject" class="btn right" onclick="addProject();"
									style="margin: 5px;"><i class="material-icons left">check</i>Done</a>

							</div>
						</div>

					</div>
				</div>
			</div>
		</div>
	</div>


	<div id="loginModal" class="modal" style="max-width: 500px;">

		<div class="modal-content">

			<div class="row">
				<div class="testcase col s12" style="padding: 0px; height: 100%;">
					<div class="row" style="height: 100%; margin: auto">
						<h2>Login</h2>

						<form class="col s12 white" style="height: 100%" id="inform">
							<div class="row">
								<div class="input-field col s12">
									<input id="userName" type="text" class="validate"><label
										for="userName">UserName/Handle</label>
								</div>
								<div class="input-field col s12">
									<input id="password" type="password" class="validate"><label
										for="password">Password</label>
								</div>
							</div>

						</form>
						<div class="row">
							<div class="input-field col s12" id="actionsL">
								<a id="login_b" class="btn right" style="margin: 5px;"><i
									class="material-icons left">send</i>Proceed</a>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal Structure -->
	<div id="executeModal" class="modal">
		<a href="#!"
			class=" modal-action modal-close waves-effect waves-green btn right">CLOSE</a>

		<div class="modal-content">

			<div class="row">
				<div class="testcase col s12" style="padding: 0px">

					<div class="row" style="height: 100%">
						<form class="col s12 white" style="height: 100%" id="inform">
							<div class="row">
								<div class="input-field col s6">
									<input id="pname" type="text" class="validate" disabled><label
										for="testcaseId">ProjectName</label>
								</div>
								<div class="input-field col s6">
									<input id="uname" type="text" class="validate" disabled><label
										for="testcaseId">UserName</label>
								</div>
							</div>



							<div class="row">
								<div class="input-field col s12" id="execTagsc">

									<div class="chips chips-initial" id="execTags"></div>
								</div>
							</div>


							<div class="row">
								<!-- 								<p>Choose target server only if you wanted to execte the test case on any other server than the original request</p>
 -->
								<div class="input-field col s12">
									<select multiple id="sselect">

									</select> <label>Choose a target Server (Optional)</label>
								</div>
							</div>



						</form>
						<div class="row">
							<div class="input-field col s12" id="actions">

								<button class="button" id="executeTest">Execute</button>
							</div>

							<div class="row">
								<div class="input-field col s12">

									<a href="" id="execURL" target="_blank"></a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal Structure -->
	<div id="modal1" class="modal"
		style="width: 100%; max-height: 100%; height: 100%;">
		<a href="#!"
			class=" modal-action modal-close waves-effect waves-green btn right">CLOSE</a>

		<div class="modal-content" style="height: 100%; padding: 0px">

			<nav class=" center" style="background: #124191">
				<a class="btn-floating btn-large waves-effect waves-light orange"
					id="saveTest"><i class="material-icons">save</i></a> <a
					class="btn-floating btn-large waves-effect waves-light green"
					id="execute"><i class="material-icons">send</i></a>
			</nav>

			<div class="row">
				<div class="testcase col s8" style="padding: 0px">

					<div class="row black" style="height: 100%">
						<form class="col s4 white" style="height: 100%" id="inform">
							<div class="row">
								<div class="input-field col s12">
									<input id="projectNameText" type="text" class="validate"
										disabled>
								</div>
							</div>


							<div class="row">
								<div class="input-field col s12">
									<input id="testcaseId" type="text" class="validate"> <label
										for="testcaseId">TestCase Id</label>
								</div>
							</div>

							<div class="row">
								<div class="input-field col s12">
									<input id="testcaseName" type="text" class="validate">
									<label for="testcaseName">TestCase Name</label>
								</div>
							</div>

							<div class="row">
								<div class="input-field col s12">
									<input id="testcaseGroup" type="text" class="validate"
										value="General"> <label for="testcaseGroup">TestCase
										Group (Eg: road/split)</label>
								</div>
							</div>

							<div class="row">
								<div class="input-field col s12">
									<textarea id="description" class="materialize-textarea"></textarea>
									<label for="description">Description</label>
								</div>
							</div>

							<div class="row">
								<div class="input-field col s12" id="tagc">
									<div class="chips chips-initial" id="tags"></div>
								</div>
							</div>



						</form>

						<div class="col s8" style="padding: 0px">

							<div class="card" style="margin: 0px">
								<textarea id="testcaseJson"
									style="height: 100%; overflow-y: scroll; background: #010b1e; color: white;">
								</textarea>
							</div>

						</div>

					</div>

				</div>

				<div class="col s4" style="padding: 0px">

					<div class="card" style="margin: 0px">
						<textarea id="console"
							style="height: 100%; overflow-y: scroll; background: #010b1e; color: white;">
						</textarea>
					</div>

				</div>
			</div>

			<p id="testCaseCloudURL" style="display: none">/herest/</p>

		</div>

	</div>



	<div class="preloader-wrapper big active" id="progress"
		style="position: absolute; top: 50%; left: 50%; display: none">
		<div class="spinner-layer spinner-blue">
			<div class="circle-clipper left">
				<div class="circle"></div>
			</div>
			<div class="gap-patch">
				<div class="circle"></div>
			</div>
			<div class="circle-clipper right">
				<div class="circle"></div>
			</div>
		</div>

		<div class="spinner-layer spinner-red">
			<div class="circle-clipper left">
				<div class="circle"></div>
			</div>
			<div class="gap-patch">
				<div class="circle"></div>
			</div>
			<div class="circle-clipper right">
				<div class="circle"></div>
			</div>
		</div>

		<div class="spinner-layer spinner-yellow">
			<div class="circle-clipper left">
				<div class="circle"></div>
			</div>
			<div class="gap-patch">
				<div class="circle"></div>
			</div>
			<div class="circle-clipper right">
				<div class="circle"></div>
			</div>
		</div>

		<div class="spinner-layer spinner-green">
			<div class="circle-clipper left">
				<div class="circle"></div>
			</div>
			<div class="gap-patch">
				<div class="circle"></div>
			</div>
			<div class="circle-clipper right">
				<div class="circle"></div>
			</div>
		</div>
	</div>
	<!-- <script
		src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js"></script> -->

	<script
		src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
	<script type="text/javascript" src="assets/js/materialize.min.js"></script>

	<script type="text/javascript" src="assets/js/mustache.js"></script>

	<script type="text/javascript"
		src="http://static.jstree.com/3.0.0-beta3/assets/dist/jstree.min.js"></script>


	<script id="read_boundingbox" type="text/plain">

	</script>

	<script id="testCaseTemplateFooter" type="text/plain">	
	
	</script>
	<script>
		var projectName=getCurrentProject();
		var userName="";
		var server="";
		var targetHosts = null;
		
		function logOff(){
			localStorage.removeItem("userInfo");
			location.reload();
		}
		
		function renderProjects(callBack){
			var command=server+"/herest/projects/project?userName="+userName;
			$.getJSON(command,function(data){
				
				var hits = data.hits.hits;
				for(var k in hits){
					var name=((hits[k])["_source"]).name;
					$("#dropdown2").append('<li class="divider"></li><li><a href="#">'+name+'</a></li>');
				}
				
				callBack();
			});
		}
		
		function checkLogin(){
			
			var user ={email:"test@test.com"};//getCurrentUser();
			
			if(!user || !user.email){
			
				$("#loginModal").openModal({
			        dismissible:false,
			    	ready: function() { 
				    	  Materialize.updateTextFields();			    	  
				   }
			    });
			
			}else{
				userName = user.email;
				
				$("#userDisplayName").html(user.displayName);
				$("#userEmail").html(user.email);
			}
			
			
			
			$("#login_b").click(function(){
				
				var user = {userName:$("#userName").val(),password:$("#password").val()};
				var command = server+"/auth/login";
				
				execCommand(command, "POST",JSON.stringify(user), function(out) {
					if(!out.email){
						alert("Failed to Authenticate");
					}else{
						setCurrentUser(out);
						checkLogin();
						$("#loginModal").closeModal();
					}
				});
				
			});
		}
		
		function addHost(){
			var command=server+"/herest/"+projectName+"/hosts/"+$("#nameInput").val()+"?userName="+userName;
			
			var host = {
				name:$("#nameInput").val(),
				
				host:$("#hostInput").val()
			}
		
			execCommand(command, "POST",JSON.stringify(host) , function(out,status) {
				if(status===200||status===201){
					
					
					setTimeout(function(){
						renderHosts();	
					}, 2000);
				}
			});
			
		}
		
		
		function addProject(){
			
			var command=server+"/herest/projects/project/"+$("#nprojectName").val()+"?userName="+userName;
			
			var project = {
					
				name:$("#nprojectName").val(),
				
				description:$("#npdescription").val()
			};
			
			execCommand(command, "POST",JSON.stringify(project) , function(out,status) {
				if(status===200||status===201){
					
					alert("Project created Successfully : "+project.name)
					
					$("#openProjectModal").closeModal();
				}
			});
			
		}
		
		function renderHosts(){
			$("#hostTable tbody").empty();
			
			var command=server+"/herest/"+projectName+"/hosts?userName="+userName;
			
			$.getJSON(command,function(data){
		    	var recs =data.hits?data.hits.hits:new Array();
		    	targetHosts = new Array();
		    	for(var k in recs){
		    		
		    		var o = recs[k];
		    		
		    		o = o["_source"];
		    		
		    		targetHosts.push(o);
		    		
					$("#hostTable tbody").append("<tr><td>"+o.name+"</td><td>"+o.host+"</td></tr>");
					
		    	}
		    	populateServers();
			});
		}
		
		function populateServers(){
			$('#sselect').empty();
			$('#sselect').append('<option value="" disabled selected>Choose your option</option>');
			for(var k in targetHosts){
				var op = '<option value="'+targetHosts[k].name+'">'+targetHosts[k].name+'('+targetHosts[k].host+')</option>';
				
				$('#sselect').append(op);
			}
			
			$('#sselect').material_select();
		}
		$(document).ready(
				
				
				function() {
					
					$("#addHost").click(function(){
						
						addHost();
					});
					
					renderProjects(function(){
						
						$("#dropdown2 a").click(function() {
							
							$("#projectName").html($(this).html());
							
							projectName = $("#projectName").html();
							
							setCurrentProject(projectName);
							
							initProjectTree();
							
							renderHosts();
							
						});
					});
					
					
					$('.modal-execute').leanModal({
					      dismissible: true, // Modal can be dismissed by clicking outside of the modal
					      opacity: .5, // Opacity of modal background
					      in_duration: 300, // Transition in duration
					      out_duration: 200, // Transition out duration
					      starting_top: '4%', // Starting top style attribute
					      ending_top: '10%', // Ending top style attribute
					      ready: function() { 
					    	  
					    						   	  }, 
					      complete: function() { 
					    	  
					    	 
					      } 
					 });
					
					$('.modal-trigger').leanModal({
					      dismissible: true, // Modal can be dismissed by clicking outside of the modal
					      opacity: .5, // Opacity of modal background
					      in_duration: 300, // Transition in duration
					      out_duration: 200, // Transition out duration
					      starting_top: '4%', // Starting top style attribute
					      ending_top: '10%', // Ending top style attribute
					      ready: function() { 
					    	  
					    	  $(".modal-content iframe").remove();
					    	  
					    	 // $(".modal-content .testcase").empty();
					    	  
					    	 // $(".modal-content .testcase").append('<div name="childDoc" id="childDoc" style="width:100%;height:100%;border: 1px solid #ddd;"></div>');
					    	 
					    	 $("#projectNameText").val(projectName);
					    	 
					    	 initProjectTree();
					    	  
					    	 $("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					    	 
					    	 
					    	  
					    	  //alert(JSON.stringify(fetchMetaInfo()));
					    	  }, // Callback for Modal open
					      complete: function() { 
					    	  
					    	 
					      } // Callback for Modal close
					    });
					
					//$('select').material_select();

					/* $(".abc").select2({
						tags : true,
						tokenSeparators : [ ',', ' ' ]
					}) */
					//projectName = $("#projectName").html();
					if(projectName && projectName!="")
					initProjectTree();
					$("#dropdown1 a").click(function() {
						
						if($(this).html()=="GET"){
							
							disableReqBody();
						}else{
							
							enableReqBody();
						}

						$("#request").html($(this).html());
					});
					
					

					$("#send").click(function(){
						sendData(function(){
							if(cObject){
			    				var asserts = cObject._source.steps[0].assertions;
				    			
				    			for(var k in asserts){
				    				
				    				assert(asserts[k].expect,true,true); 
				    			}
				    			$("#openAssert").click();
							}
			    			isRunning=false;
		    			});
					});
					
					if($("#dropdown1 a").html()=="GET"){
						disableReqBody();
					}
					
					$("#executeTest").click(function() {
						var tags=$('#execTags').material_chip('data');
						var mt = "";
						var app="";
						for(var i=0;i<tags.length;i++){
							mt+=app+tags[i].tag;
							app=","
						}
						var command=server+"/herest/execute?userName="+userName+"&projectName="+projectName+"&tags="+mt;
						$("#console").html("Running .......................................");
						execCommand(command, "POST", "", function(out) {
							//$("#console").html(JSON.stringify(out,null,3));
							if(out.status=="SUCCESS"){
								var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light green"><i class="material-icons">done</i></a>Success</span>');
								Materialize.toast($toastContent, 5000);
								$("#execURL").html("Result:"+out.executionId);
								$("#execURL").attr("href","/teststatus.html?executionId="+out.executionId);
								
							}else{
								var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">shuffle</i></a>Failed</span>');
								Materialize.toast($toastContent, 5000);
							}
						}); 
					});
					$("#execute").click(	
							function() {
								var command=server+"/rtest/execute";
								$("#console").html("Running .......................................");
								execCommand(command, "POST", $("#testcaseJson").val(), function(out) {
									$("#console").html(JSON.stringify(out,null,3));
									if(out.status=="SUCCESS"){
										var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light green"><i class="material-icons">done</i></a>Success</span>');
										Materialize.toast($toastContent, 5000);
									}else{
										var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">shuffle</i></a>Failed</span>');
										Materialize.toast($toastContent, 5000);
									}
								}); 
					});
					
					
					$("#saveTest").click(	
							function() {
								var command=server+"/herest/"+projectName+"/testCase?userName="+userName;
								$("#console").html("Running .......................................");
								execCommand(command, "POST", $("#testcaseJson").val(), function(out,status) {
									$("#console").html(JSON.stringify(out,null,3));
									if(status==200 ||status==201){
										var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light green"><i class="material-icons">done</i></a>Success</span>');
										Materialize.toast($toastContent, 5000);
									}else{
										var $toastContent = $('<span><a class="btn-floating btn-large waves-effect waves-light red"><i class="material-icons">shuffle</i></a>Failed</span>');
										Materialize.toast($toastContent, 5000);
									}
								}); 
					});
					
					$('#tags').material_chip({
					    data: [{
					      tag: 'smoke',
					    }, {
					      tag: 'read',
					    }, {
					      tag: 'write',
					    }],
					 });

					 $("#inform input").change(function(){
							
							$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });
					 $("#inform textarea").change(function(){
							
							$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });
					
					$('#tags').on('chip.add', function(e, chip){
						$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });

					$('#tags').on('chip.delete', function(e, chip){
						$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });
					
					checkLogin();
					
					renderHosts();
					

				});
		$("#addAssertion").click(function() {
			var cv = $("#queryInput").val();
			assert(cv,true);
		});

		$("#queryInput").change(function() {
			var cv = $("#queryInput").val();
			assert(cv);
		});
		var start_time = 0;

		function assert(cv,addNow,ignoreFail) {

			try {
				var prefix = ""
				if(cv.indexOf("responseCode")==-1){
					//prefix="currentOut.";
				}
				var out = eval(prefix + cv);

				$("#queryOutput").html(
						(out == null) ? "undefined" : JSON.stringify(out));

				if ((out == true && addNow) || ignoreFail) {
					
					var strO =out?"check":"error";
					var color =out?"green":"red";

					var statusButton ="<td ><i  class=\"btn-floating waves-effect waves-light "+color+" material-icons center\">"+strO+"</i></td>";
					
					
					$("#queryTable tbody").append(
							"<tr><td class='assert'>" + cv + "</td>"+statusButton+" <td onclick=\"$(this).parent().remove();\"><i  id=\"removeAssertion\" class=\"btn-floating waves-effect waves-light material-icons center\">delete</i></td></tr>");
				} else if (addNow) {

					$("#queryOutput").html("Evaluates to a non boolean value");
				}
			} catch (e) {
				$("#queryOutput").html(JSON.stringify(e.message));
			}
		}
		
		function sendData(callBack){
				if(isRunning){
		    			
		    		return "";
		    	}
				isRunning=true;
				send($("#url").val(), $("#request").html(), $(
						"#requestBody").val(), function(out) {

					$("#responseBody").val(
							JSON.stringify(out, null, "\t"));
					if(callBack){
						callBack();
					}
					isRunning=false;
				});
		}
		function send(url, method, data, callBack) {
			$
					.ajax({
						url : url,
						type : method,
						data : data,
						contentType : "application/json",
						beforeSend : function(request, settings) {
							$("#progress").css("display", "block");
							$("#timeTaken span").html("------");
							$("#responseCode span").html("-----");
							$("#responseIcon").html('');

							start_time = new Date().getTime();

						},
						success : function(data, textStatus, jqXHR) {
							var request_time = new Date().getTime()
									- start_time;
							$("#responseCode span").html(jqXHR.status);
							$("#timeTaken span").html(request_time);

							if (jqXHR.status >= 200 && jqXHR.status <= 300) {
								$("#responseIcon")
										.html(
												'<i class="btn-floating waves-effect waves-light green material-icons center">done</i>');

							} else {
								$("#responseIcon")
										.html(
												'<i class="btn-floating waves-effect waves-light red material-icons center">error</i>');

							}
							responseCode = jqXHR.status;
							
							response = data;
							callBack(data);
							$("#progress").css("display", "none");
						},
						error : function(jqXHR, textStatus, errorThrown) {
							if (jqXHR.status == 404
									|| errorThrown == 'Not Found') {
								console.log('There was a 404 error.');
							}
							var request_time = new Date().getTime()
									- start_time;
							$("#timeTaken span").html(request_time);
							responseCode = (jqXHR.status == 0) ? 0 : jqXHR.status;
							$("#responseCode span").html(responseCode);
							//alert(jqXHR.getResponseHeader("Access-Control-Allow-Headers")	);
							$("#responseIcon")
									.html(
											'<i class="btn-floating waves-effect waves-light red material-icons center">error</i>');
							if(callBack){
								if(jqXHR.responseText){
									var ret = jqXHR.responseText;
									try{
										ret = JSON.parse(jqXHR.responseText)
									}catch(e){
										
									}
									callBack(ret);
								}else{
									callBack(textStatus);
								}
							}
							$("#progress").css("display", "none");

						},
						statusCode : {
							404 : function(response) {
								console.log('Invalid Transaction details');
							},
							200 : function(response) {
								//response processing code here
							}
						},
					});
		}
		
		function execCommand(url, method, data, callBack) {
			$
					.ajax({
						url : url,
						type : method,
						data : data,
						contentType : "application/json",
						beforeSend : function(request, settings) {
							
							start_time = new Date().getTime();

						},
						success : function(data, textStatus, jqXHR) {
							var request_time = new Date().getTime()
									- start_time;
							callBack(data,jqXHR.status);
						},
						error : function(jqXHR, textStatus, errorThrown) {
							if (jqXHR.status == 404
									|| errorThrown == 'Not Found') {
								console.log('There was a 404 error.');
							}
							var request_time = new Date().getTime()
									- start_time;
							
							callBack(errorThrown,jqXHR.status);

						}
					});
		}
		//var currentOut = null;
		var response = null;
		var responseCode=0;
		
		function htmlDecode(value){ 
			  return $('<div/>').html(value).text(); 
		}
		
		function getTestCaseJson(){
			
			var url = $("#url").val();
			var urlS = url.split("?");
			var tokens = urlS[0].split("/");
			var layerName = tokens[3];
			var method=$("#request").html();
			var assertions = new Array();
			$("#queryTable tbody tr td.assert").each(function(i,td){
				var objAssert = new Object();
				objAssert.expect = htmlDecode($(td).html());
				objAssert.name = "";
				objAssert.message = "Expected: ,Actual : {{"+objAssert.expect+"}}";
				assertions.push(objAssert);
			});
			var tags=$('#tags').material_chip('data');
			var mt = new Array();
			for(var i=0;i<tags.length;i++){
				mt.push(tags[i].tag);
			}
			var inj = {};//new Object();
			try{
				inj = JSON.parse($("#requestBody").val());
			}catch(e){
				//inj = $("#requestBody").val();
				
				
			}
			var group = $("#testcaseGroup").val();
			if(!group || group==""){
				group = "General";
			}
			return {
				name:$("#testcaseName").val(),
				group:group,
				description:$("#description").val(),
				id:$("#testcaseId").val(),
				tags:mt,
				steps:[{
				stepIndex:1,
				name:$("#testcaseName").val(),
				url:url,
				id:$("#testcaseId").val(),
				description:$("#description").val(),
				
				input:inj,
				method:$("#request").html(),
				assertions: assertions 
				}]
			}
			
			
		}
		function fetchMetaInfo(){
			var url = $("#url").val();
			var urlS = url.split("?");
			var tokens = urlS[0].split("/");
			var layerName = tokens[3];
			var method=$("#request").html();
			var operation = "unknown";
			var operationType = "unknown";
			
			var boundingbox={};
			var userName="";
			
			var params = urlS[1].split("&");
			for(var k in params){
				var kv = k.split("=");
				if(kv[0]=="userName"){
					userName=kv[1];
				}
			}
			
			var id="";
			if(urlS.length>1  && method=="GET"){
				if(urlS[1].indexOf("minx")!=-1){
					operation="read_boundingbox";
					var tok=urlS[1].split("&");
					for(var k in tok){
						
						var kv =tok[k].split("=");
						if(kv[0]=="minx"){
							boundingbox.minx=kv[1];
						}
						if(kv[0]=="maxx"){
							boundingbox.maxx=kv[1];
						}
						if(kv[0]=="miny"){
							boundingbox.miny=kv[1];
						}
						if(kv[0]=="maxy"){
							boundingbox.maxy=kv[1];
						}
					}
					
				}else if(tokens.length==5){
					operation="single_read";
					id=tokens[4];
				}
				operationType="Read";
			}
			else if(urlS.length>1  && method=="PUT"){
				operationType="Write";
				if(tokens.length==5){
					if(tokens[4]=="batch"){
						operation="batch_update";
					}else{
						operation="single_update";
						id=tokens[4];
					}
				}
					
				
			}else if(urlS.length>1  && method=="POST"){
				operationType="Write";
				if(tokens.length==5){
					
					if(tokens[4]=="batch"){
						operation="batch_create";
					}else{
						operation="unknown";
					}
				}else{
					
					operation="single_create";
				}
					
				
			}else if(urlS.length>1  && method=="DELETE"){
				operationType="Write";
				if(tokens.length==5){
					
					if(tokens[4]=="batch"){
						operation="batch_delete";
					}else{
						operation="single_delete";
						id=tokens[4];
					}
				}
					
				
			}
			var assertions = [];
			
			
			$("#queryTable tbody tr td.assert").each(function(i,td){
				assertions.push($(td).html());
				
			});
			var asserts="";
			
			for(var a in assertions){
				
				asserts+="assert "+ assertions[a]+"\n	";
			}
			var context= {url:$("#url").val(),layerName:layerName,serverName:tokens[2],operation:operation,operationType:operationType,method:method,boundingbox:boundingbox,id:id,asserts:asserts,userName:userName};
			return createCMSTestCase(context);
		}
		
		function createCMSTestCase(context){
			  var template = $('#'+context.operation).html();
			  Mustache.parse(template);   // optional, speeds up future uses
			  var rendered = Mustache.render(template, context);
			  context.payload=rendered;
			  //alert(rendered);
			  template = $('#testCaseTemplate').html();
			  Mustache.parse(template);   // optional, speeds up future uses
			  rendered = Mustache.render(template, context);
			  return rendered;
			
		}
		
	    function disableReqBody(){
	    	
			
			$("#requestBody").css("background","#aaa");
			$("#requestBody").attr("disabled", true);
			$("#requestBody").val("");
			
	    }
		function enableReqBody(){
	    	
			
			$("#requestBody").css("background","#123456");
			$("#requestBody").attr("disabled", false);
			
	    }
		
		
		function initProjectTree() {

		    $(".search-input").keyup(function() {
		        var searchString = $(this).val();
		        console.log(searchString);
		        $('#jstree').jstree('search', searchString);
		    });

		    var url = $("#testCaseCloudURL").html()+projectName+"/testCase/_search?size=5000";
		    
		    $.getJSON(url,function(data){
		    	var recs =data.hits?data.hits.hits:new Array();
		    	
		    	
		    	var children =new Array();
		    	var groupsMap =[];
		    	for(var k in recs){
		    		var rec = recs[k]._source;
		    		var group = rec.group;
		    		if(!group || group==""){
		    			group="General"
		    		}
		    		var gp=groupsMap[group];
		    		if(!gp){
		    			gp =new Array();
		    			groupsMap[group]=gp;
		    		}
		    		gp.push({
	                    "id": rec.id,
	                    "text": rec.name,
	                    "icon": "assets/images/eye.png",
	                    "state": {
	                        "opened": true,
	                        "disabled": false,
	                        "selected": false
	                    },
	                    "children": false,
	                    "liAttributes": null,
	                    "aAttributes": null
	                });
		    	}
		    	for(var k in groupsMap){
		    		
		    		children.push({
		                "id": k,
		                "text":k,
		                "icon": "",
		                "state": {
		                    "opened": true,
		                    "disabled": false,
		                    "selected": false
		                },
		                "children":groupsMap[k],
		                "liAttributes": null,
		                "aAttributes": null
		            });
		    	}
		    	
		    	$('#jstree').jstree("destroy")
		    	$('#jstree').jstree({
			        'core': {

			            'data': [{
			                "id": "1.0",
			                "text": "All",
			                "icon": "",
			                "state": {
			                    "opened": true,
			                    "disabled": false,
			                    "selected": false
			                },
			                "children":children,
			                "liAttributes": null,
			                "aAttributes": null
			            }]



			        },
			        "search": {

			            "case_insensitive": true,
			            "show_only_matches" : true,
			            "fuzzy":false


			        },

			        "plugins": ["search"]


			    });
		    	
		    	
		    	initTreeEvents();
		    	

		    	
		    });
		    
		}
		var treeInited=false;
		
		var isRunning = false;
		var cObject=null;
		function initTreeEvents(){
			
			treeInited=true;
			
			$('#jstree').on("select_node.jstree", function (e, data) {
				
				if(data.node.children.length >0){
				    console.log("not leaf");
				    $("#executeModal").openModal({
				    	ready: function() { 
					    	  
					    	  $('#execTags').material_chip({
								    data: [{
								      tag: 'all',
								    }],
								 });
					    	  
  								$("#pname").val(projectName);
					    	  
					    	  $("#uname").val(userName);
					    	  
					    	  $("#execURL").html("");
					    	  
					    	  Materialize.updateTextFields();

					    	  
					   	  }
				    });
				    return;
				}
				else{
				    console	.log("leaf");
				    
				    $("#responseBody").val("");
				    
				    if($("#respCard .card-reveal").css("display")=="block"){
				    	
				    	$("#respCard .card-reveal").css("display","none");
				    }
				    
				}  
				
	    		
	    		var ur = $("#testCaseCloudURL").html()+projectName+"/testCase/"+data.node.id;
	    		
	    		$.getJSON(ur,function(object){
	    			
	    			//alert(JSON.stringify(object));
	    			
	    			
	    			$("#queryTable tbody").empty();
	    			
	    			$("#url").val(object._source.steps[0].url);
	    			
	    			$("#request").html(object._source.steps[0].method);
	    			
	    			if($("#request").html()!="GET"){
	    			
	    				$("#requestBody").val(JSON.stringify(object._source.steps[0].input,null,2));
	    				
	    				enableReqBody();
	    			
	    			}else{
	    				$("#requestBody").val("");
	    				
	    				disableReqBody();
	    			}
	    			
	    			$("#testcaseId").val(object._source.id);
	    			
	    			$("#testcaseName").val(object._source.name);
	    			
	    			$("#projectNameText").val(projectName);
	    			
	    			$("#description").val(object._source.description);
	    			
	    			 Materialize.updateTextFields();
	    			
	    			var tags = object._source.tags;
	    			var tgA = new Array();
	    			for(var x in tags){
	    				tgA.push({tag:tags[x]});
	    				
	    			}
	    			
	    			$('#tags').remove();
	    			
	    			$('#tagc').append('<div class="chips chips-initial" id="tags"></div>');
	    			
	    			$('#tags').material_chip({
					    data: tgA
					 });
	    			
	    			$('#tags').on('chip.add', function(e, chip){
						$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });

					$('#tags').on('chip.delete', function(e, chip){
						$("#testcaseJson").val(JSON.stringify(getTestCaseJson(),null,2));
					  });
	    			
	    			cObject=object;
	    			
	    			
	    			
	    		});
	    		
	    	
	    	});
		}

		function getCurrentProject(){
			var project = localStorage.getItem("projectName", "Select Project");
			document.getElementById("projectName").innerHTML = project;
			//alert(project);
			return project;
		}
		function setCurrentProject(name){
			
			localStorage.setItem("projectName", name);
		}
		
		function getCurrentUser(){
			var project = localStorage.getItem("userInfo",null);
			if(project){
				try{
					project = JSON.parse(project);
				}catch(e){
					console.log(e);
					project=null;
				}
			}
			return project;
		}
		function setCurrentUser(user){
			
			localStorage.setItem("userInfo", JSON.stringify(user));
		}
		
		
		
		
	</script>
</body>
</html>
